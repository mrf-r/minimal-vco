#include "vco.h"
#include "bsp.h"

// GEN2_MAX_OCTAVE_OFFSET must be power of 2 !
#define GEN2_MAX_OCTAVE_OFFSET 4
// MAX_ADC must be power of 2 !
#define MAX_PWM 333
// TABLE_SIZE must be power of 2 !
#define TABLE_SIZE 512

static struct {
  uint32_t inc;
  uint32_t recp;
} table_pitch_inc[TABLE_SIZE + 1] = {
    {0x2c9b3, 0x5b2a}, {0x2d414, 0x59db},  {0x2de9c, 0x5891},
    {0x2e94c, 0x574c}, {0x2f423, 0x560c},  {0x2ff22, 0x54d0},
    {0x30a4b, 0x5399}, {0x3159d, 0x5266},  {0x32119, 0x5138},
    {0x32cc0, 0x500d}, {0x33893, 0x4ee8},  {0x34491, 0x4dc6},
    {0x350bc, 0x4ca9}, {0x35d14, 0x4b8f},  {0x3699b, 0x4a7a},
    {0x37650, 0x4969}, {0x38334, 0x485b},  {0x39048, 0x4752},
    {0x39d8d, 0x464c}, {0x3ab04, 0x454a},  {0x3b8ac, 0x444c},
    {0x3c687, 0x4351}, {0x3d496, 0x425a},  {0x3e2da, 0x4166},
    {0x3f152, 0x4076}, {0x40001, 0x3f8a},  {0x40ee5, 0x3ea0},
    {0x41e02, 0x3dbb}, {0x42d57, 0x3cd8},  {0x43ce4, 0x3bf9},
    {0x44cac, 0x3b1d}, {0x45caf, 0x3a44},  {0x46ced, 0x396e},
    {0x47d67, 0x389b}, {0x48e1f, 0x37cb},  {0x49f15, 0x36ff},
    {0x4b04b, 0x3635}, {0x4c1c0, 0x356e},  {0x4d377, 0x34aa},
    {0x4e56f, 0x33e8}, {0x4f7aa, 0x332a},  {0x50a29, 0x326e},
    {0x51ced, 0x31b5}, {0x52ff7, 0x30ff},  {0x54348, 0x304b},
    {0x556e1, 0x2f99}, {0x56ac3, 0x2eeb},  {0x57eee, 0x2e3f},
    {0x59365, 0x2d95}, {0x5a828, 0x2cee},  {0x5bd39, 0x2c49},
    {0x5d298, 0x2ba6}, {0x5e846, 0x2b06},  {0x5fe45, 0x2a68},
    {0x61496, 0x29cc}, {0x62b3a, 0x2933},  {0x64233, 0x289c},
    {0x65980, 0x2807}, {0x67125, 0x2774},  {0x68922, 0x26e3},
    {0x6a178, 0x2654}, {0x6ba29, 0x25c8},  {0x6d335, 0x253d},
    {0x6ec9f, 0x24b4}, {0x70668, 0x242e},  {0x72090, 0x23a9},
    {0x73b1a, 0x2326}, {0x75607, 0x22a5},  {0x77158, 0x2226},
    {0x78d0f, 0x21a8}, {0x7a92d, 0x212d},  {0x7c5b4, 0x20b3},
    {0x7e2a4, 0x203b}, {0x80001, 0x1fc5},  {0x81dcb, 0x1f50},
    {0x83c04, 0x1edd}, {0x85aad, 0x1e6c},  {0x879c9, 0x1dfc},
    {0x89958, 0x1d8e}, {0x8b95d, 0x1d22},  {0x8d9d9, 0x1cb7},
    {0x8facf, 0x1c4e}, {0x91c3e, 0x1be6},  {0x93e2b, 0x1b7f},
    {0x96095, 0x1b1a}, {0x98380, 0x1ab7},  {0x9a6ed, 0x1a55},
    {0x9cade, 0x19f4}, {0x9ef54, 0x1995},  {0xa1453, 0x1937},
    {0xa39db, 0x18da}, {0xa5fef, 0x187f},  {0xa8690, 0x1825},
    {0xaadc2, 0x17cd}, {0xad585, 0x1775},  {0xafddd, 0x171f},
    {0xb26cb, 0x16ca}, {0xb5051, 0x1677},  {0xb7a71, 0x1624},
    {0xba52f, 0x15d3}, {0xbd08c, 0x1583},  {0xbfc8a, 0x1534},
    {0xc292c, 0x14e6}, {0xc5674, 0x1499},  {0xc8465, 0x144e},
    {0xcb301, 0x1403}, {0xce24a, 0x13ba},  {0xd1244, 0x1372},
    {0xd42f0, 0x132a}, {0xd7452, 0x12e4},  {0xda66b, 0x129e},
    {0xdd93f, 0x125a}, {0xe0cd0, 0x1217},  {0xe4121, 0x11d4},
    {0xe7635, 0x1193}, {0xeac0e, 0x1152},  {0xee2b0, 0x1113},
    {0xf1a1e, 0x10d4}, {0xf525a, 0x1096},  {0xf8b67, 0x105a},
    {0xfc549, 0x101e}, {0x100002, 0xfe2},  {0x103b96, 0xfa8},
    {0x107808, 0xf6f}, {0x10b55b, 0xf36},  {0x10f392, 0xefe},
    {0x1132b1, 0xec7}, {0x1172ba, 0xe91},  {0x11b3b3, 0xe5b},
    {0x11f59d, 0xe27}, {0x12387d, 0xdf3},  {0x127c55, 0xdc0},
    {0x12c12b, 0xd8d}, {0x130700, 0xd5b},  {0x134dda, 0xd2a},
    {0x1395bc, 0xcfa}, {0x13dea9, 0xcca},  {0x1428a6, 0xc9c},
    {0x1473b6, 0xc6d}, {0x14bfde, 0xc40},  {0x150d21, 0xc13},
    {0x155b84, 0xbe6}, {0x15ab0b, 0xbbb},  {0x15fbba, 0xb90},
    {0x164d95, 0xb65}, {0x16a0a1, 0xb3b},  {0x16f4e3, 0xb12},
    {0x174a5e, 0xaea}, {0x17a118, 0xac1},  {0x17f914, 0xa9a},
    {0x185258, 0xa73}, {0x18ace8, 0xa4d},  {0x1908ca, 0xa27},
    {0x196602, 0xa02}, {0x19c495, 0x9dd},  {0x1a2488, 0x9b9},
    {0x1a85e0, 0x995}, {0x1ae8a3, 0x972},  {0x1b4cd6, 0x94f},
    {0x1bb27d, 0x92d}, {0x1c199f, 0x90b},  {0x1c8242, 0x8ea},
    {0x1cec6a, 0x8c9}, {0x1d581d, 0x8a9},  {0x1dc561, 0x889},
    {0x1e343c, 0x86a}, {0x1ea4b4, 0x84b},  {0x1f16ce, 0x82d},
    {0x1f8a92, 0x80f}, {0x200004, 0x7f1},  {0x20772c, 0x7d4},
    {0x20f010, 0x7b7}, {0x216ab5, 0x79b},  {0x21e724, 0x77f},
    {0x226561, 0x764}, {0x22e575, 0x748},  {0x236766, 0x72e},
    {0x23eb3a, 0x713}, {0x2470fa, 0x6f9},  {0x24f8ab, 0x6e0},
    {0x258256, 0x6c7}, {0x260e01, 0x6ae},  {0x269bb4, 0x695},
    {0x272b77, 0x67d}, {0x27bd52, 0x665},  {0x28514b, 0x64e},
    {0x28e76c, 0x637}, {0x297fbb, 0x620},  {0x2a1a42, 0x609},
    {0x2ab708, 0x5f3}, {0x2b5615, 0x5dd},  {0x2bf773, 0x5c8},
    {0x2c9b2a, 0x5b3}, {0x2d4143, 0x59e},  {0x2de9c6, 0x589},
    {0x2e94bc, 0x575}, {0x2f422f, 0x561},  {0x2ff228, 0x54d},
    {0x30a4b0, 0x53a}, {0x3159d1, 0x526},  {0x321194, 0x513},
    {0x32cc04, 0x501}, {0x33892a, 0x4ee},  {0x344910, 0x4dc},
    {0x350bc1, 0x4cb}, {0x35d146, 0x4b9},  {0x3699ab, 0x4a8},
    {0x3764fb, 0x497}, {0x38333f, 0x486},  {0x390483, 0x475},
    {0x39d8d3, 0x465}, {0x3ab039, 0x455},  {0x3b8ac2, 0x445},
    {0x3c6878, 0x435}, {0x3d4967, 0x426},  {0x3e2d9c, 0x416},
    {0x3f1523, 0x407}, {0x400008, 0x3f9},  {0x40ee58, 0x3ea},
    {0x41e01f, 0x3dc}, {0x42d56a, 0x3ce},  {0x43ce47, 0x3c0},
    {0x44cac2, 0x3b2}, {0x45caea, 0x3a4},  {0x46cecb, 0x397},
    {0x47d674, 0x38a}, {0x48e1f3, 0x37d},  {0x49f156, 0x370},
    {0x4b04ab, 0x363}, {0x4c1c02, 0x357},  {0x4d3769, 0x34b},
    {0x4e56ef, 0x33f}, {0x4f7aa3, 0x333},  {0x50a296, 0x327},
    {0x51ced7, 0x31b}, {0x52ff76, 0x310},  {0x543483, 0x305},
    {0x556e0f, 0x2fa}, {0x56ac2b, 0x2ef},  {0x57eee7, 0x2e4},
    {0x593654, 0x2d9}, {0x5a8285, 0x2cf},  {0x5bd38b, 0x2c5},
    {0x5d2978, 0x2ba}, {0x5e845e, 0x2b0},  {0x5fe450, 0x2a7},
    {0x614960, 0x29d}, {0x62b3a2, 0x293},  {0x642328, 0x28a},
    {0x659808, 0x280}, {0x671253, 0x277},  {0x689220, 0x26e},
    {0x6a1781, 0x265}, {0x6ba28c, 0x25c},  {0x6d3357, 0x254},
    {0x6ec9f5, 0x24b}, {0x70667e, 0x243},  {0x720907, 0x23b},
    {0x73b1a6, 0x232}, {0x756073, 0x22a},  {0x771583, 0x222},
    {0x78d0ef, 0x21b}, {0x7a92ce, 0x213},  {0x7c5b39, 0x20b},
    {0x7e2a46, 0x204}, {0x800011, 0x1fc},  {0x81dcb0, 0x1f5},
    {0x83c03e, 0x1ee}, {0x85aad5, 0x1e7},  {0x879c8e, 0x1e0},
    {0x899585, 0x1d9}, {0x8b95d4, 0x1d2},  {0x8d9d97, 0x1cb},
    {0x8face9, 0x1c5}, {0x91c3e6, 0x1be},  {0x93e2ac, 0x1b8},
    {0x960957, 0x1b2}, {0x983804, 0x1ab},  {0x9a6ed2, 0x1a5},
    {0x9cadde, 0x19f}, {0x9ef547, 0x199},  {0xa1452d, 0x193},
    {0xa39dae, 0x18e}, {0xa5feec, 0x188},  {0xa86906, 0x182},
    {0xaadc1e, 0x17d}, {0xad5855, 0x177},  {0xafddcd, 0x172},
    {0xb26ca9, 0x16d}, {0xb5050b, 0x167},  {0xb7a716, 0x162},
    {0xba52f0, 0x15d}, {0xbd08bc, 0x158},  {0xbfc8a0, 0x153},
    {0xc292c0, 0x14e}, {0xc56744, 0x14a},  {0xc84651, 0x145},
    {0xcb300f, 0x140}, {0xce24a7, 0x13c},  {0xd1243f, 0x137},
    {0xd42f02, 0x133}, {0xd74519, 0x12e},  {0xda66ad, 0x12a},
    {0xdd93ea, 0x126}, {0xe0ccfc, 0x121},  {0xe4120e, 0x11d},
    {0xe7634c, 0x119}, {0xeac0e5, 0x115},  {0xee2b06, 0x111},
    {0xf1a1de, 0x10d}, {0xf5259d, 0x109},  {0xf8b671, 0x106},
    {0xfc548d, 0x102}, {0x1000021, 0xfe},  {0x103b960, 0xfb},
    {0x107807c, 0xf7}, {0x10b55a9, 0xf3},  {0x10f391c, 0xf0},
    {0x1132b0a, 0xec}, {0x1172ba8, 0xe9},  {0x11b3b2d, 0xe6},
    {0x11f59d1, 0xe2}, {0x12387cd, 0xdf},  {0x127c558, 0xdc},
    {0x12c12ae, 0xd9}, {0x1307008, 0xd6},  {0x134dda3, 0xd3},
    {0x1395bbb, 0xd0}, {0x13dea8e, 0xcd},  {0x1428a59, 0xca},
    {0x1473b5d, 0xc7}, {0x14bfdd8, 0xc4},  {0x150d20d, 0xc1},
    {0x155b83d, 0xbe}, {0x15ab0ab, 0xbc},  {0x15fbb9b, 0xb9},
    {0x164d951, 0xb6}, {0x16a0a15, 0xb4},  {0x16f4e2d, 0xb1},
    {0x174a5e0, 0xaf}, {0x17a1178, 0xac},  {0x17f913f, 0xaa},
    {0x1852580, 0xa7}, {0x18ace87, 0xa5},  {0x1908ca2, 0xa2},
    {0x196601f, 0xa0}, {0x19c494d, 0x9e},  {0x1a2487f, 0x9c},
    {0x1a85e04, 0x99}, {0x1ae8a31, 0x97},  {0x1b4cd5a, 0x95},
    {0x1bb27d5, 0x93}, {0x1c199f8, 0x91},  {0x1c8241b, 0x8f},
    {0x1cec699, 0x8d}, {0x1d581ca, 0x8b},  {0x1dc560d, 0x89},
    {0x1e343bd, 0x87}, {0x1ea4b3a, 0x85},  {0x1f16ce3, 0x83},
    {0x1f8a91a, 0x81}, {0x2000042, 0x7f},  {0x20772c0, 0x7d},
    {0x20f00f8, 0x7b}, {0x216ab53, 0x7a},  {0x21e7238, 0x78},
    {0x2265614, 0x76}, {0x22e5750, 0x75},  {0x236765a, 0x73},
    {0x23eb3a3, 0x71}, {0x2470f99, 0x70},  {0x24f8ab0, 0x6e},
    {0x258255b, 0x6c}, {0x260e010, 0x6b},  {0x269bb46, 0x69},
    {0x272b776, 0x68}, {0x27bd51c, 0x66},  {0x28514b3, 0x65},
    {0x28e76b9, 0x63}, {0x297fbb0, 0x62},  {0x2a1a41a, 0x61},
    {0x2ab7079, 0x5f}, {0x2b56155, 0x5e},  {0x2bf7735, 0x5c},
    {0x2c9b2a3, 0x5b}, {0x2d4142a, 0x5a},  {0x2de9c59, 0x59},
    {0x2e94bc0, 0x57}, {0x2f422f0, 0x56},  {0x2ff227e, 0x55},
    {0x30a4b00, 0x54}, {0x3159d0e, 0x52},  {0x3211944, 0x51},
    {0x32cc03e, 0x50}, {0x338929b, 0x4f},  {0x34490fd, 0x4e},
    {0x350bc08, 0x4d}, {0x35d1462, 0x4c},  {0x3699ab5, 0x4a},
    {0x3764faa, 0x49}, {0x38333f0, 0x48},  {0x3904837, 0x47},
    {0x39d8d31, 0x46}, {0x3ab0395, 0x45},  {0x3b8ac1a, 0x44},
    {0x3c6877a, 0x43}, {0x3d49673, 0x42},  {0x3e2d9c5, 0x41},
    {0x3f15234, 0x40}, {0x4000084, 0x40},  {0x40ee57f, 0x3f},
    {0x41e01f0, 0x3e}, {0x42d56a5, 0x3d},  {0x43ce471, 0x3c},
    {0x44cac27, 0x3b}, {0x45cae9f, 0x3a},  {0x46cecb5, 0x39},
    {0x47d6745, 0x39}, {0x48e1f32, 0x38},  {0x49f1560, 0x37},
    {0x4b04ab6, 0x36}, {0x4c1c020, 0x35},  {0x4d3768c, 0x35},
    {0x4e56eed, 0x34}, {0x4f7aa37, 0x33},  {0x50a2965, 0x32},
    {0x51ced73, 0x32}, {0x52ff761, 0x31},  {0x5434834, 0x30},
    {0x556e0f3, 0x30}, {0x56ac2ab, 0x2f},  {0x57eee6a, 0x2e},
    {0x5936546, 0x2e}, {0x5a82855, 0x2d},  {0x5bd38b3, 0x2c},
    {0x5d29780, 0x2c}, {0x5e845e0, 0x2b},  {0x5fe44fc, 0x2a},
    {0x6149600, 0x2a}, {0x62b3a1d, 0x29},  {0x6423288, 0x29},
    {0x659807b, 0x28}, {0x6712536, 0x27},  {0x68921fa, 0x27},
    {0x6a17810, 0x26}, {0x6ba28c5, 0x26},  {0x6d33569, 0x25},
    {0x6ec9f54, 0x25}, {0x70667e0, 0x24},  {0x720906e, 0x24},
    {0x73b1a63, 0x23}, {0x756072a, 0x23},  {0x7715833, 0x22},
    {0x78d0ef4, 0x22}, {0x7a92ce6, 0x21},  {0x7c5b38b, 0x21},
    {0x7e2a468, 0x20}, {0x8000109, 0x20},  {0x81dcafe, 0x1f},
    {0x83c03e0, 0x1f}, {0x85aad4b, 0x1e},  {0x879c8e2, 0x1e},
    {0x899584e, 0x1e}, {0x8b95d3f, 0x1d},  {0x8d9d96a, 0x1d},
    {0x8face8b, 0x1c}, {0x91c3e65, 0x1c},  {0x93e2ac0, 0x1b},
    {0x960956c, 0x1b}, {0x9838040, 0x1b},  {0x9a6ed18, 0x1a},
    {0x9caddd9, 0x1a}, {0x9ef546f, 0x1a},  {0xa1452ca, 0x19},
    {0xa39dae6, 0x19}, {0xa5feec2, 0x18},  {0xa869067, 0x18},
    {0xaadc1e6, 0x18}, {0xad58555, 0x17},  {0xafddcd5, 0x17},
    {0xb26ca8c, 0x17}, {0xb5050aa, 0x16},  {0xb7a7166, 0x16},
    {0xba52f00, 0x16}, {0xbd08bc1, 0x16},  {0xbfc89f8, 0x15},
    {0xc292c00, 0x15}, {0xc567439, 0x15},  {0xc846510, 0x14},
    {0xcb300f7, 0x14}, {0xce24a6c, 0x14},  {0xd1243f4, 0x13},
    {0xd42f021, 0x13}, {0xd74518a, 0x13},  {0xda66ad2, 0x13},
    {0xdd93ea8, 0x12}, {0xe0ccfc0, 0x12},  {0xe4120db, 0x12},
    {0xe7634c5, 0x12}, {0xeac0e54, 0x11},  {0xee2b066, 0x11},
    {0xf1a1de7, 0x11}, {0xf5259cc, 0x11},  {0xf8b6716, 0x10},
    {0xfc548d0, 0x10}, {0x10000211, 0x10}, {0x103b95fd, 0x10},
    {0x107807c0, 0xf}, {0x10b55a96, 0xf},  {0x10f391c4, 0xf},
    {0x1132b09c, 0xf}, {0x1172ba7e, 0xf},  {0x11b3b2d4, 0x1d},
};

#define CELL_STEPS (65536 / TABLE_SIZE)
// static inline void oscIncGet(uint16_t pitch, uint32_t* inc, uint32_t* recp) {
void oscIncGet(uint16_t pitch, uint32_t* inc, uint32_t* recp) {
  uint32_t pos = pitch / CELL_STEPS;
  uint32_t spos = pitch & (CELL_STEPS - 1);
  uint32_t v0 = table_pitch_inc[pos].inc;
  *recp = table_pitch_inc[pos].recp;
  int32_t diff = table_pitch_inc[pos + 1].inc - v0;
  *inc = v0 + diff * spos / (0x800000 / 1024);
}

void vcoInit(Vco* vco) {
  vco->calib_scale =
      ((65536 / 128 * 12 * PITCH_OCTAVES_RANGE) * 65536) / MAX_ADC;
  vco->calib_offset = 65536 / 128 * 12;
}

void vcoCalibrationLoad(Vco* vco, uint32_t scale, int32_t offset) {
  vco->calib_scale = scale;
  vco->calib_offset = offset;
}

static inline int32_t pd(uint32_t inc, int32_t noise16) {
  return (inc / 65536) * noise16;
}

void vcoTap(Vco* vco) {
#ifdef DEBUG
  uint32_t cycles = bspTimerGet();
#endif  // DEBUG
  int32_t lcg = vco->lcg;
  lcg = lcg * 1103515245 + 12345;
  vco->lcg = lcg;
  int32_t lcg16 = lcg / 65536;

  // pitch calibration
  int32_t base_pitch =
      vco->adc[ADC_PITCH] * vco->calib_scale / 65536 + vco->calib_offset;
  if (base_pitch < 0) {
    base_pitch = 0;
  } else {
    if (base_pitch > 65535) {
      base_pitch = 65535;
    }
  }

  uint32_t base_inc;
  uint32_t base_recp;
  oscIncGet(base_pitch, &base_inc, &base_recp);
  vco->debug1 = base_inc;
  // gen1 core
  int32_t gen1new = vco->gen1 + base_inc;
  // int32_t gen1new = vco->gen1 + 0x100000000ULL / SAMPLE_RATE * 2600;

  // gen1 octave
  // PD must be calculated for every octave
  const uint32_t oct_fade_steps = MAX_ADC / 4;
  uint32_t oct_mul = vco->adc[ADC_OCTAVE] / oct_fade_steps + 1;
  uint32_t oct_fade = vco->adc[ADC_OCTAVE] & (oct_fade_steps - 1);
  // get 2 octaves of gen1 signal with PDAM
  int32_t gen1o1 = gen1new * (1 << oct_mul) + pd(base_inc * oct_mul, lcg16);
  int32_t gen1o2 = gen1new * (2 << oct_mul) + pd(base_inc * oct_mul, lcg16);
  // x-fade them
  int32_t gen1full = gen1o1 / oct_fade_steps * (oct_fade_steps - 1 - oct_fade) +
                     gen1o2 / oct_fade_steps * oct_fade;
  // vco->pwm[0] = ((gen1full + 0x80000000) / 65536 * MAX_PWM + (uint32_t)lcg16)
  // / 65536;
  vco->pwm[0] = gen1full / 65536 + 0x8000;
  // vco->pwm[0] = gen1o2 / 65536 + 0x8000;
  // GEN2 is hard synced to gen1core
  uint32_t inc2 = base_inc + base_inc / (MAX_ADC / GEN2_MAX_OCTAVE_OFFSET) *
                                 vco->adc[ADC_GEN2PITCH];
  int32_t gen2new;
  if (gen1new < vco->gen1) {
    // sync gen2
    uint32_t adc_sync = vco->adc[ADC_SYNC] * vco->adc[ADC_SYNC] / MAX_ADC;
    if (adc_sync < ((uint32_t)lcg16 * MAX_ADC / 65536UL)) {
      uint32_t subpos_norm = (gen1new & 0x7FFFFFFF) * base_recp;
      gen2new = (subpos_norm / 65536) * inc2 / 65536;
      // random phase on a rare events
      gen2new += lcg16 * (adc_sync * 65536 / MAX_ADC);
      // phasemod disabled, need depth knob
      gen2new += (vco->adc[ADC_SYNCPHASE] - MAX_ADC / 2) *
                 ((int32_t)(0x100000000ULL / MAX_ADC));
    } else {
      goto nosync;
    }
  } else {
  nosync:
    gen2new = vco->gen2 + inc2;
  }
  vco->gen1 = gen1new;

  int32_t gen2o = gen2new + pd(gen2new - vco->gen2, lcg16);
  vco->gen2 = gen2new;

  int32_t adc_mix = vco->adc[ADC_GEN1AMP] - MAX_ADC / 2;
  int32_t adc_mix_abs = adc_mix < 0 ? -adc_mix : adc_mix;
  int32_t mix = (gen2o / MAX_ADC) * (MAX_ADC - 1 - adc_mix_abs) +
                (gen1full / MAX_ADC) * adc_mix;
  vco->pwm[1] =
      ((mix + 0x80000000) / 65536 * MAX_PWM + (uint32_t)lcg16) / 65536;

#ifdef DEBUG
  uint32_t proc_cycles = bspTimerGet() - cycles;
  if (vco->cycles < proc_cycles)
    vco->cycles = proc_cycles;
  else
    vco->cycles--;
#endif  // DEBUG
}
